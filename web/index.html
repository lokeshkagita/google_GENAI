<!DOCTYPE html>
<html lang="en">
<head>
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta name="description" content="MoodSync - AI-powered emotional wellness and mood matching platform">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MoodSync">
  <meta name="theme-color" content="#667eea">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <title>MoodSync</title>

  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Enhanced Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* Advanced Global Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    html, body {
      height: 100vh;
      width: 100vw;
      font-family: 'Poppins', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      overflow: hidden;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      position: relative;
      margin: 0;
      padding: 0;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* FIXED: Hide loader when app starts */
    body.app-started {
      overflow: visible !important;
    }

    body.app-started #flutter_container,
    body.app-started .overlay,
    body.app-started .slideshow,
    body.app-started .floating-orb,
    body.app-started .audio-controls,
    body.app-started .particle {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }

    /* Background Slideshow */
    .slideshow {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -2;
      overflow: hidden;
    }

    .slideshow img {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      animation: fade 30s infinite;
      transition: opacity 2s ease-in-out;
    }

    .slideshow img:nth-child(1) { animation-delay: 0s; }
    .slideshow img:nth-child(2) { animation-delay: 6s; }
    .slideshow img:nth-child(3) { animation-delay: 12s; }
    .slideshow img:nth-child(4) { animation-delay: 18s; }
    .slideshow img:nth-child(5) { animation-delay: 24s; }

    @keyframes fade {
      0% { opacity: 0; }
      10% { opacity: 1; }
      20% { opacity: 1; }
      30% { opacity: 0; }
      100% { opacity: 0; }
    }

    /* Dark Overlay */
    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.45);
      z-index: -1;
    }

    #flutter_container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      transform-origin: center;
      z-index: 2;
    }

    /* Glass Card Styling */
    .glass-card {
      position: relative;
      width: 380px;
      padding: 40px;
      text-align: center;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(18px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      z-index: 2;
      animation: fadeInUp 1.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    /* Audio Controls - FIXED positioning and styling */
    .audio-controls {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .audio-toggle {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.4);
      background: rgba(255, 255, 255, 0.15);
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      color: #fff;
      backdrop-filter: blur(10px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .audio-toggle.playing {
      animation: pulse 3s infinite;
      border-color: rgba(76, 175, 80, 0.6);
      background: rgba(76, 175, 80, 0.2);
    }

    .audio-toggle:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
    }

    .audio-toggle.muted {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 107, 107, 0.4);
      animation: none;
    }

    .audio-toggle.muted:hover {
      background: rgba(255, 107, 107, 0.15);
    }

    /* FIXED: Sound selector positioning and visibility */
    .sound-selector {
      position: absolute;
      top: 60px;
      right: 0;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(15px);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 10px;
      display: none;
      flex-direction: column;
      gap: 8px;
      min-width: 140px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      transform: translateY(-10px);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .sound-selector.visible {
      display: flex;
      transform: translateY(0);
      opacity: 1;
    }

    .sound-option {
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s ease;
      text-align: center;
      font-weight: 500;
    }

    .sound-option:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(255, 255, 255, 0.1);
    }

    .sound-option.active {
      background: rgba(76, 175, 80, 0.3);
      border-color: rgba(76, 175, 80, 0.5);
      box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
      color: #fff;
    }

    /* Welcome Text Styling */
    #welcome {
      font-size: 1.2rem;
      font-weight: bold;
      color: #ffecb3;
      margin-bottom: 15px;
      height: 25px;
      animation: fadeText 2s ease-in-out;
      transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes fadeText {
      from { 
        opacity: 0; 
        transform: translateY(10px);
      }
      to { 
        opacity: 1; 
        transform: translateY(0);
      }
    }

    @keyframes textFadeTransition {
      0% {
        opacity: 1;
        transform: translateY(0);
      }
      25% {
        opacity: 0;
        transform: translateY(-10px);
      }
      75% {
        opacity: 0;
        transform: translateY(10px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .glass-card h1 {
      font-size: 1.8rem;
      color: #fff;
      margin-bottom: 10px;
      font-weight: 700;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .glass-card p {
      color: #f1f1f1;
      font-size: 1rem;
      margin-bottom: 25px;
      opacity: 0.9;
    }

    /* Start Button */
    .start-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      margin: auto;
      color: #fff;
      font-weight: bold;
      animation: pulse 2s infinite;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
    }

    .start-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
      box-shadow: 0 8px 25px rgba(255, 255, 255, 0.2);
    }

    @keyframes pulse {
      0% { 
        box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.6); 
      }
      70% { 
        box-shadow: 0 0 0 20px rgba(255, 255, 255, 0); 
      }
      100% { 
        box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); 
      }
    }

    @keyframes fadeInUp {
      0% { 
        opacity: 0; 
        transform: translateY(30px) scale(0.95); 
      }
      100% { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
      }
    }

    /* Floating Elements */
    .floating-orb {
      position: absolute;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, 
        rgba(255, 255, 255, 0.2) 0%, 
        rgba(255, 255, 255, 0.05) 40%, 
        transparent 70%);
      filter: blur(1px);
      animation: float 8s ease-in-out infinite;
      z-index: 1;
    }

    .floating-orb:nth-child(1) {
      width: 200px;
      height: 200px;
      top: 10%;
      left: 15%;
      animation-delay: 0s;
    }

    .floating-orb:nth-child(2) {
      width: 150px;
      height: 150px;
      top: 60%;
      right: 20%;
      animation-delay: 2s;
    }

    .floating-orb:nth-child(3) {
      width: 100px;
      height: 100px;
      bottom: 20%;
      left: 60%;
      animation-delay: 4s;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      25% { transform: translateY(-15px) rotate(90deg); }
      50% { transform: translateY(-8px) rotate(180deg); }
      75% { transform: translateY(-20px) rotate(270deg); }
    }

    /* Particle System */
    .particle {
      position: absolute;
      width: 3px;
      height: 3px;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 50%;
      pointer-events: none;
      animation: particleFloat 12s linear infinite;
      z-index: 1;
    }

    @keyframes particleFloat {
      0% {
        transform: translateY(100vh) translateX(0) rotate(0deg);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translateY(-10vh) translateX(100px) rotate(360deg);
        opacity: 0;
      }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .glass-card {
        width: 320px;
        padding: 30px 25px;
        margin: 0 20px;
      }
      
      #welcome {
        font-size: 1.1rem;
      }
      
      .glass-card h1 {
        font-size: 1.6rem;
      }
      
      .glass-card p {
        font-size: 0.9rem;
      }
      
      .floating-orb {
        opacity: 0.6;
      }

      .audio-controls {
        top: 15px;
        right: 15px;
      }

      .audio-toggle {
        width: 45px;
        height: 45px;
      }

      .sound-selector {
        min-width: 120px;
      }
    }

    @media (max-width: 480px) {
      .glass-card {
        width: 280px;
        padding: 25px 20px;
      }
      
      #welcome {
        font-size: 1rem;
      }
      
      .glass-card h1 {
        font-size: 1.4rem;
      }
      
      .glass-card p {
        font-size: 0.85rem;
      }

      .start-btn {
        width: 60px;
        height: 60px;
      }
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
      .glass-card {
        background: rgba(0, 0, 0, 0.8);
        border: 2px solid white;
      }
      
      .overlay {
        background: rgba(0, 0, 0, 0.7);
      }
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <!-- Background Slideshow -->
  <div class="slideshow">
    <img src="https://images.unsplash.com/photo-1507525428034-b723cf961d3e" alt="Ocean" loading="eager">
    <img src="https://images.unsplash.com/photo-1506748686214-e9df14d4d9d0" alt="Mountains" loading="lazy">
    <img src="https://images.unsplash.com/photo-1501785888041-af3ef285b470" alt="Forest" loading="lazy">
    <img src="https://images.unsplash.com/photo-1503264116251-35a269479413" alt="Sunset" loading="lazy">
    <img src="https://images.unsplash.com/photo-1470770841072-f978cf4d019e" alt="Sky" loading="lazy">
  </div>

  <!-- Dark Overlay -->
  <div class="overlay"></div>

  <!-- Floating Orbs -->
  <div class="floating-orb"></div>
  <div class="floating-orb"></div>
  <div class="floating-orb"></div>

  <!-- Audio Controls -->
  <div class="audio-controls">
    <div class="audio-toggle" onclick="toggleAudio()" tabindex="0" role="button" aria-label="Toggle ambient sounds">
      <svg id="audio-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
      </svg>
    </div>
    
    <div id="sound-selector" class="sound-selector">
      <div class="sound-option active" data-sound="rain" onclick="selectSound('rain')">Rain Forest</div>
      <div class="sound-option" data-sound="ocean" onclick="selectSound('ocean')">Ocean Waves</div>
      <div class="sound-option" data-sound="wind" onclick="selectSound('wind')">Gentle Wind</div>
      <div class="sound-option" data-sound="birds" onclick="selectSound('birds')">Morning Birds</div>
    </div>
  </div>

  <!-- Flutter Container -->
  <div id="flutter_container">
    <div class="glass-card">
      <div id="welcome">Welcome</div>
      <h1>SAHAYAM</h1>
      <p>Premium Stress Relief Experience</p>
      <div class="start-btn" onclick="startApp()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="5,3 19,12 5,21 5,3"></polygon>
        </svg>
      </div>
    </div>
  </div>

  <!-- Flutter Bootstrap -->
  <script src="flutter_bootstrap.js" async></script>

  <!-- Enhanced Google Maps Integration -->
  <script src="MAPS_API_KEY" async defer></script>

  <script>
    // FIXED SAHAYAM Web Integration with Working Audio
    class SahayamWebIntegration {
      constructor() {
        this.welcomeTexts = [
          { text: 'Welcome', lang: 'en', name: 'English' },
          { text: 'स्वागत है', lang: 'hi', name: 'Hindi' },
          { text: 'स्वागत आहे', lang: 'mr', name: 'Marathi' },
          { text: 'வரவேற்கிறோம்', lang: 'ta', name: 'Tamil' },
          { text: 'સ્વાગત છે', lang: 'gu', name: 'Gujarati' }
        ];
        this.currentWelcomeIndex = 0;
        this.welcomeInterval = null;
        this.particleInterval = null;
        this.isDestroyed = false;
        
        // FIXED: Audio properties with proper state management
        this.audioEnabled = false;
        this.isAudioPlaying = false;
        this.currentSound = 'rain';
        this.audioContext = null;
        this.currentOscillators = [];
        this.gainNode = null;
        this.soundSelectorVisible = false;
        
        // Simple sound generation parameters
        this.soundConfigs = {
          rain: { 
            frequencies: [80, 120, 200, 300], 
            volumes: [0.08, 0.06, 0.04, 0.02],
            type: 'sawtooth'
          },
          ocean: { 
            frequencies: [40, 80, 160], 
            volumes: [0.12, 0.08, 0.04],
            type: 'sine'
          },
          wind: { 
            frequencies: [100, 200, 400], 
            volumes: [0.10, 0.06, 0.03],
            type: 'triangle'
          },
          birds: { 
            frequencies: [800, 1200, 1600, 2000], 
            volumes: [0.05, 0.04, 0.03, 0.02],
            type: 'sine'
          }
        };
        
        this.init();
      }

      init() {
        this.setupAudio();
        this.setupEventListeners();
        this.startWelcomeAnimation();
        this.createParticleSystem();
        this.setupPerformanceOptimizations();
        this.initializeAccessibility();
        this.preloadImages();
        
        // Make instance globally accessible
        window.sahayamIntegration = this;
        
        console.log('SAHAYAM Integration initialized successfully');
      }

      // FIXED: Proper audio setup
      setupAudio() {
        try {
          // Initialize Web Audio API
          this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
          this.gainNode = this.audioContext.createGain();
          this.gainNode.connect(this.audioContext.destination);
          this.gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
          
          console.log('Audio system initialized');
        } catch (error) {
          console.log('Web Audio API not supported:', error);
        }
      }

      // FIXED: Proper audio generation
      startAudio(soundType = this.currentSound) {
        if (!this.audioContext || this.isAudioPlaying) return;
        
        console.log(`Starting ${soundType} audio`);
        
        const config = this.soundConfigs[soundType] || this.soundConfigs.rain;
        this.currentOscillators = [];
        
        try {
          // Resume audio context if suspended
          if (this.audioContext.state === 'suspended') {
            this.audioContext.resume();
          }
          
          config.frequencies.forEach((freq, index) => {
            const oscillator = this.audioContext.createOscillator();
            const oscGain = this.audioContext.createGain();
            const filter = this.audioContext.createBiquadFilter();
            
            // Connect: oscillator -> filter -> gain -> main gain -> destination
            oscillator.connect(filter);
            filter.connect(oscGain);
            oscGain.connect(this.gainNode);
            
            // Configure oscillator
            oscillator.type = config.type;
            oscillator.frequency.setValueAtTime(freq, this.audioContext.currentTime);
            
            // Configure filter for more natural sound
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(freq * 2, this.audioContext.currentTime);
            filter.Q.setValueAtTime(1, this.audioContext.currentTime);
            
            // Configure volume
            oscGain.gain.setValueAtTime(0, this.audioContext.currentTime);
            oscGain.gain.linearRampToValueAtTime(config.volumes[index], this.audioContext.currentTime + 2);
            
            // Start oscillator
            oscillator.start(this.audioContext.currentTime);
            
            // Add frequency modulation for more natural sound
            this.modulateFrequency(oscillator, freq);
            
            this.currentOscillators.push({ oscillator, gain: oscGain, filter });
          });
          
          // Fade in main volume
          this.gainNode.gain.linearRampToValueAtTime(0.3, this.audioContext.currentTime + 3);
          
          this.isAudioPlaying = true;
          this.updateAudioButton();
          
        } catch (error) {
          console.log('Error starting audio:', error);
        }
      }

      // FIXED: Proper audio stopping
      stopAudio() {
        if (!this.isAudioPlaying || !this.audioContext) return;
        
        console.log('Stopping audio');
        
        try {
          // Fade out
          this.gainNode.gain.linearRampToValueAtTime(0, this.audioContext.currentTime + 0.5);
          
          // Stop all oscillators after fade out
          setTimeout(() => {
            this.currentOscillators.forEach(({ oscillator }) => {
              try {
                oscillator.stop();
              } catch (e) {
                // Oscillator might already be stopped
              }
            });
            this.currentOscillators = [];
            this.isAudioPlaying = false;
            this.updateAudioButton();
          }, 600);
          
        } catch (error) {
          console.log('Error stopping audio:', error);
          this.isAudioPlaying = false;
          this.updateAudioButton();
        }
      }

      // FIXED: Frequency modulation for natural sound
      modulateFrequency(oscillator, baseFreq) {
        const modulation = () => {
          if (this.isDestroyed || !this.isAudioPlaying) return;
          
          try {
            const variation = baseFreq * 0.02; // 2% variation
            const newFreq = baseFreq + (Math.random() - 0.5) * variation;
            oscillator.frequency.linearRampToValueAtTime(newFreq, this.audioContext.currentTime + 1);
            
            setTimeout(modulation, 2000 + Math.random() * 3000);
          } catch (e) {
            // Oscillator might be stopped
          }
        };
        
        setTimeout(modulation, 1000);
      }

      // FIXED: Audio button state management
      updateAudioButton() {
        const audioToggle = document.querySelector('.audio-toggle');
        const audioIcon = document.getElementById('audio-icon');
        
        if (!audioToggle || !audioIcon) return;
        
        if (this.isAudioPlaying) {
          audioToggle.classList.add('playing');
          audioToggle.classList.remove('muted');
          audioIcon.innerHTML = `
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
          `;
          audioToggle.setAttribute('aria-label', 'Disable ambient sounds');
        } else {
          audioToggle.classList.remove('playing');
          audioToggle.classList.add('muted');
          audioIcon.innerHTML = `
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <line x1="23" y1="9" x2="17" y2="15"></line>
            <line x1="17" y1="9" x2="23" y2="15"></line>
          `;
          audioToggle.setAttribute('aria-label', 'Enable ambient sounds');
        }
      }

      setupEventListeners() {
        // Flutter first frame event
        window.addEventListener('flutter-first-frame', () => {
          this.startMainAnimations();
        });

        // FIXED: Click outside to close sound selector
        document.addEventListener('click', (e) => {
          const soundSelector = document.getElementById('sound-selector');
          const audioToggle = document.querySelector('.audio-toggle');
          
          if (soundSelector && 
              !soundSelector.contains(e.target) && 
              !audioToggle.contains(e.target) &&
              this.soundSelectorVisible) {
            this.hideSoundSelector();
          }
        });

        // Enhanced mouse interactions
        this.setupMouseInteractions();

        // Touch interactions
        this.setupTouchInteractions();

        // Resize and visibility handling
        this.setupResponsiveHandling();
      }

      setupMouseInteractions() {
        const mouseMoveHandler = this.throttle((e) => {
          if (this.isDestroyed) return;
          
          const x = e.clientX / window.innerWidth;
          const y = e.clientY / window.innerHeight;
          
          // Subtle parallax for glass card
          const glassCard = document.querySelector('.glass-card');
          if (glassCard && window.innerWidth > 768) {
            const moveX = (x - 0.5) * 8;
            const moveY = (y - 0.5) * 8;
            glassCard.style.transform = `translate(${moveX}px, ${moveY}px)`;
          }

          // Interactive orb effects
          document.querySelectorAll('.floating-orb').forEach((orb) => {
            const distance = Math.sqrt(Math.pow(x - 0.5, 2) + Math.pow(y - 0.5, 2));
            const scale = 1 + (1 - distance) * 0.15;
            const rotation = distance * 20;
            orb.style.transform = `scale(${scale}) rotate(${rotation}deg)`;
          });
        }, 16);

        document.addEventListener('mousemove', mouseMoveHandler, { passive: true });
      }

      setupTouchInteractions() {
        const touchStartHandler = (e) => {
          if (this.isDestroyed) return;
          const glassCard = document.querySelector('.glass-card');
          if (glassCard) {
            glassCard.style.transform = 'scale(0.98)';
            glassCard.style.transition = 'transform 0.1s cubic-bezier(0.4, 0, 0.2, 1)';
          }
        };

        const touchEndHandler = (e) => {
          if (this.isDestroyed) return;
          const glassCard = document.querySelector('.glass-card');
          if (glassCard) {
            glassCard.style.transform = 'scale(1)';
            glassCard.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
          }
        };

        document.addEventListener('touchstart', touchStartHandler, { passive: true });
        document.addEventListener('touchend', touchEndHandler, { passive: true });
      }

      setupResponsiveHandling() {
        let resizeTimeout;
        window.addEventListener('resize', () => {
          if (this.isDestroyed) return;
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            const isMobile = window.innerWidth <= 768;
            const glassCard = document.querySelector('.glass-card');
            if (glassCard && isMobile) {
              glassCard.style.transform = 'scale(1)';
            }
          }, 250);
        });

        // Visibility change optimization
        document.addEventListener('visibilitychange', () => {
          if (this.isDestroyed) return;
          
          const isVisible = !document.hidden;
          
          // Pause/resume animations based on visibility
          const animatedElements = document.querySelectorAll('.floating-orb, .particle');
          animatedElements.forEach(el => {
            el.style.animationPlayState = isVisible ? 'running' : 'paused';
          });

          // Pause/resume slideshow
          const slideshowImages = document.querySelectorAll('.slideshow img');
          slideshowImages.forEach(img => {
            img.style.animationPlayState = isVisible ? 'running' : 'paused';
          });
        });
      }

      // FIXED: Sound selector visibility management
      showSoundSelector() {
        const soundSelector = document.getElementById('sound-selector');
        if (soundSelector) {
          soundSelector.classList.add('visible');
          this.soundSelectorVisible = true;
        }
      }

      hideSoundSelector() {
        const soundSelector = document.getElementById('sound-selector');
        if (soundSelector) {
          soundSelector.classList.remove('visible');
          this.soundSelectorVisible = false;
        }
      }

      throttle(func, limit) {
        let throttleTimeout = null;
        return (...args) => {
          if (this.isDestroyed || throttleTimeout) return;
          throttleTimeout = setTimeout(() => {
            func.apply(this, args);
            throttleTimeout = null;
          }, limit);
        };
      }

      startWelcomeAnimation() {
        const welcomeElement = document.getElementById('welcome');
        if (!welcomeElement) return;

        this.updateWelcomeText(welcomeElement);

        this.welcomeInterval = setInterval(() => {
          if (this.isDestroyed) return;
          this.currentWelcomeIndex = (this.currentWelcomeIndex + 1) % this.welcomeTexts.length;
          this.updateWelcomeText(welcomeElement);
        }, 2000);
      }

      updateWelcomeText(element) {
        const currentWelcome = this.welcomeTexts[this.currentWelcomeIndex];
        
        element.style.animation = 'textFadeTransition 1s cubic-bezier(0.4, 0, 0.2, 1)';
        
        setTimeout(() => {
          element.textContent = currentWelcome.text;
          element.setAttribute('lang', currentWelcome.lang);
          element.setAttribute('data-language', currentWelcome.name);
        }, 250);

        setTimeout(() => {
          element.style.animation = 'fadeText 2s ease-in-out';
        }, 1000);
      }

      startMainAnimations() {
        const container = document.getElementById('flutter_container');
        if (container) {
          container.classList.add('loaded');
        }
      }

      createParticleSystem() {
        if (this.isDestroyed) return;
        
        const particleCount = window.innerWidth < 768 ? 10 : 20;
        
        for (let i = 0; i < particleCount; i++) {
          setTimeout(() => {
            if (!this.isDestroyed) {
              this.createParticle();
            }
          }, i * 300);
        }

        this.particleInterval = setInterval(() => {
          if (!document.hidden && !this.isDestroyed) {
            this.createParticle();
          }
        }, 1500);
      }

      createParticle() {
        if (this.isDestroyed) return;
        
        const particle = document.createElement('div');
        particle.className = 'particle';
        
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDuration = (10 + Math.random() * 8) + 's';
        particle.style.animationDelay = Math.random() * 3 + 's';
        
        const size = 2 + Math.random() * 3;
        particle.style.width = size + 'px';
        particle.style.height = size + 'px';
        particle.style.opacity = 0.2 + Math.random() * 0.3;
        
        document.body.appendChild(particle);
        
        setTimeout(() => {
          if (particle.parentNode && !this.isDestroyed) {
            particle.parentNode.removeChild(particle);
          }
        }, 15000);
      }

      preloadImages() {
        const imageUrls = [
          'https://images.unsplash.com/photo-1507525428034-b723cf961d3e',
          'https://images.unsplash.com/photo-1506748686214-e9df14d4d9d0',
          'https://images.unsplash.com/photo-1501785888041-af3ef285b470',
          'https://images.unsplash.com/photo-1503264116251-35a269479413',
          'https://images.unsplash.com/photo-1470770841072-f978cf4d019e'
        ];

        imageUrls.forEach(url => {
          const img = new Image();
          img.src = url;
        });
      }

      setupPerformanceOptimizations() {
        const criticalImages = ['favicon.png', 'icons/Icon-192.png'];
        criticalImages.forEach(src => {
          const img = new Image();
          img.src = src;
        });

        const glassCard = document.querySelector('.glass-card');
        if (glassCard) {
          glassCard.style.willChange = 'transform';
          glassCard.style.transform3d = 'translateZ(0)';
        }
      }

      initializeAccessibility() {
        const announcer = document.createElement('div');
        announcer.setAttribute('aria-live', 'polite');
        announcer.setAttribute('aria-atomic', 'true');
        announcer.style.position = 'absolute';
        announcer.style.left = '-10000px';
        announcer.style.width = '1px';
        announcer.style.height = '1px';
        announcer.style.overflow = 'hidden';
        document.body.appendChild(announcer);

        const welcomeElement = document.getElementById('welcome');
        if (welcomeElement) {
          const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              if (mutation.type === 'childList' || mutation.type === 'characterData') {
                const currentWelcome = this.welcomeTexts[this.currentWelcomeIndex];
                announcer.textContent = `Welcome message in ${currentWelcome.name}: ${currentWelcome.text}`;
              }
            });
          });
          
          observer.observe(welcomeElement, {
            childList: true,
            characterData: true,
            subtree: true
          });
        }

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            const activeElement = document.activeElement;
            if (activeElement && activeElement.classList.contains('start-btn')) {
              startApp();
            } else if (activeElement && activeElement.classList.contains('audio-toggle')) {
              toggleAudio();
            }
          }
        });

        const startBtn = document.querySelector('.start-btn');
        if (startBtn) {
          startBtn.setAttribute('tabindex', '0');
          startBtn.setAttribute('role', 'button');
          startBtn.setAttribute('aria-label', 'Start SAHAYAM stress relief app');
        }
      }

      // FIXED: Complete cleanup when app starts
      destroy() {
        console.log('Destroying SAHAYAM loader...');
        
        this.isDestroyed = true;
        
        // Stop audio completely
        this.stopAudio();
        
        // Clear intervals
        if (this.welcomeInterval) {
          clearInterval(this.welcomeInterval);
          this.welcomeInterval = null;
        }
        
        if (this.particleInterval) {
          clearInterval(this.particleInterval);
          this.particleInterval = null;
        }
        
        // Remove particles
        const particles = document.querySelectorAll('.particle');
        particles.forEach(particle => {
          if (particle.parentNode) {
            particle.parentNode.removeChild(particle);
          }
        });
        
        // Close audio context
        if (this.audioContext) {
          this.audioContext.close().catch(e => console.log('Audio context close error:', e));
          this.audioContext = null;
        }
        
        // Clear global reference
        if (window.sahayamIntegration === this) {
          window.sahayamIntegration = null;
        }
      }
    }

    // FIXED: Audio Control Functions with proper state management
    function toggleAudio() {
      const integration = window.sahayamIntegration;
      if (!integration) {
        console.log('Integration not found');
        return;
      }

      const audioToggle = document.querySelector('.audio-toggle');
      
      if (integration.isAudioPlaying) {
        console.log('Stopping audio...');
        integration.stopAudio();
        integration.hideSoundSelector();
      } else {
        console.log('Starting audio...');
        // Request permission for audio context
        if (integration.audioContext && integration.audioContext.state === 'suspended') {
          integration.audioContext.resume().then(() => {
            integration.startAudio();
            integration.showSoundSelector();
          });
        } else {
          integration.startAudio();
          integration.showSoundSelector();
        }
      }
    }

    // FIXED: Sound selection with proper audio switching
    function selectSound(soundType) {
      const integration = window.sahayamIntegration;
      if (!integration) return;

      console.log(`Switching to sound: ${soundType}`);

      // Update active sound option UI
      document.querySelectorAll('.sound-option').forEach(option => {
        option.classList.remove('active');
      });
      const selectedOption = document.querySelector(`[data-sound="${soundType}"]`);
      if (selectedOption) {
        selectedOption.classList.add('active');
      }

      // Stop current audio if playing
      const wasPlaying = integration.isAudioPlaying;
      if (wasPlaying) {
        integration.stopAudio();
      }

      // Update current sound
      integration.currentSound = soundType;

      // Start new sound if was playing
      if (wasPlaying) {
        setTimeout(() => {
          integration.startAudio(soundType);
        }, 700); // Wait for fade out to complete
      }

      // Hide selector after selection
      setTimeout(() => {
        integration.hideSoundSelector();
      }, 1000);
    }

    // FIXED: Start App Function with complete cleanup
    function startApp() {
      console.log('Starting SAHAYAM app...');
      
      // Add body class to trigger CSS-based hiding
      document.body.classList.add('app-started');
      
      // Stop integration completely
      if (window.sahayamIntegration) {
        window.sahayamIntegration.destroy();
      }

      const glassCard = document.querySelector('.glass-card');
      
      if (glassCard) {
        // Animation sequence
        glassCard.style.transform = 'scale(1.05)';
        glassCard.style.opacity = '0.8';
        
        setTimeout(() => {
          glassCard.style.transform = 'scale(0.95)';
          glassCard.style.opacity = '0';
          
          setTimeout(() => {
            // Reset body styles for Flutter immediately
            document.body.style.cssText = `
              margin: 0 !important;
              padding: 0 !important;
              font-family: 'Poppins', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif !important;
              background: transparent !important;
              overflow: visible !important;
              height: auto !important;
              width: auto !important;
              user-select: text !important;
              -webkit-user-select: text !important;
              -moz-user-select: text !important;
              -ms-user-select: text !important;
              touch-action: manipulation !important;
              pointer-events: auto !important;
            `;
            
            document.documentElement.style.cssText = `
              height: auto !important;
              width: auto !important;
              overflow: visible !important;
            `;
            
            // Complete DOM cleanup after short delay
            setTimeout(() => {
              const elementsToRemove = [
                '#flutter_container',
                '.overlay',
                '.slideshow',
                '.floating-orb',
                '.audio-controls',
                '.particle'
              ];
              
              elementsToRemove.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => {
                  if (el && el.parentNode) {
                    el.parentNode.removeChild(el);
                  }
                });
              });
              
              console.log('SAHAYAM Loader Complete - Flutter Ready');
              
              // Notify Flutter
              window.dispatchEvent(new CustomEvent('sahayam-ready', {
                detail: { 
                  loaderComplete: true,
                  timestamp: Date.now()
                }
              }));
              
            }, 100);
            
          }, 100);
        }, 50);
      }
    }

    // Initialize when DOM is ready
    function initializeSahayam() {
      try {
        new SahayamWebIntegration();
        console.log('SAHAYAM loader initialized successfully');
      } catch (error) {
        console.error('Failed to initialize SAHAYAM loader:', error);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeSahayam);
    } else {
      initializeSahayam();
    }
  

  </script>
</body>
</html>
